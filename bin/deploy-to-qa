#!/usr/bin/env bash -eu

if [[ -z $GITHUB_TOKEN ]]; then
  >&2 echo '$GITHUB_TOKEN must be set'
  exit 1
fi

which ruby>/dev/null || echo "> Please install Ruby <"
which travis>/dev/null || gem install travis --no-rdoc --no-ri --user-install

echo "Fetching data from Travis ..."
travis endpoint -e https://travis.ibm.com/api --set-default --no-interactive
travis login -I -g $GITHUB_TOKEN --no-interactive

#get the last build that passed
build=$(travis history -b master | awk '$2 == "passed:" {print substr($1,2);exit}')
data=$(travis show $build)

#extract the (short) SHA of the head commit from the GitHub compare URL
commit=$(echo "$data" | awk -F'\\.\\.\\.' '/^Compare/ {print $2}')

git fetch -q
if git branch -r --contains $commit | grep -q deploy_qa; then
  echo "Build #$build already deployed to QA"
  exit
fi

repository=cloud-shell-cli
tag=$(date -u +%F_%H-%M-%S)

echo "Tagging $tag for build #$build of $repository ..."
git tag $tag $commit
git push -q origin $tag

echo "Deploying to QA branch ..."
git push -q origin $tag:deploy_qa
#actual deployment will be performed by Travis
echo "It may take a minute for Travis to notice the deployment."
echo "https://travis.ibm.com/composer/$repository/requests"